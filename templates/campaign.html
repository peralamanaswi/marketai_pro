<!DOCTYPE html>
<html>

<head>
  <title>Campaign - MarketAI Pro</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h2>Campaign Generator</h2>
      <div>
        <a href="/dashboard">Back</a> |
        <a href="/history">History</a> |
        <button class="btn2" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="row">
      <div>
        <input id="brand" placeholder="Brand (e.g., Nike)" />
        <input id="product" placeholder="Product (e.g., Running Shoes)" />
        <input id="audience" placeholder="Target Audience" />
        <select id="platform">
          <option>Instagram</option>
          <option>LinkedIn</option>
          <option>Facebook</option>
          <option>Twitter</option>
        </select>
        <input id="goal" placeholder="Goal (e.g., Lead generation / Sales)" />
        <select id="tone">
          <option>Professional</option>
          <option>Friendly</option>
          <option>Bold</option>
          <option>Minimal</option>
        </select>
        <select id="length">
          <option>Short</option>
          <option>Medium</option>
          <option>Long</option>
        </select>
        <button class="btn" onclick="generate()">Generate</button>
        <p class="small" id="msg"></p>
      </div>

      <div>
        <h3>Output</h3>
        <pre id="out"></pre>
        <button class="btn2" id="pdfBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
      </div>
    </div>
  </div>

  <script src="/static/js/auth.js"></script>
  <script>
    if (!getToken()) window.location.href = "/";
    let lastLogId = null;

    async function generate() {
      const payload = {
        brand: brand.value, product: product.value, audience: audience.value,
        platform: platform.value, goal: goal.value, tone: tone.value, length: length.value
      };

      const res = await fetch("/api/campaign/generate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + getToken()
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        msg.innerText = data.message || "Error";
        return;
      }
      lastLogId = data.log_id;
      out.innerText = data.result;
      pdfBtn.style.display = "inline-block";
      msg.innerText = "Saved in history âœ”";
    }

    async function downloadPDF() {
      if (!lastLogId) return;
      const res = await fetch(`/api/export/pdf/${lastLogId}`, {
        headers: { "Authorization": "Bearer " + getToken() }
      });
      if (!res.ok) { alert("Failed to download PDF"); return; }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `marketai_campaign_${lastLogId}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>